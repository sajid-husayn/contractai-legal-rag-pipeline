<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Document RAG Pipeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.healthy {
            background: #d4edda;
            color: #155724;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .upload-area:hover {
            border-color: #007bff;
        }
        
        .upload-area.dragover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .results {
            margin-top: 20px;
        }
        
        .answer {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .answer-text {
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .answer-text.collapsed {
            max-height: 120px;
            overflow: hidden;
            position: relative;
        }
        
        .answer-text.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to bottom, rgba(232,245,232,0), rgba(232,245,232,1));
            pointer-events: none;
        }
        
        .expand-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .expand-btn:hover {
            background: #218838;
        }
        
        .sources {
            margin-top: 15px;
        }
        
        .source {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .source-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .confidence {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            background: #17a2b8;
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 5px;
            color: #721c24;
        }
        
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 5px;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Legal Document RAG Pipeline</h1>
            <p>Upload legal documents and ask questions with precise source attribution</p>
            <div id="status" class="status">Loading...</div>
        </div>
        
        <div class="card">
            <h3>üìÑ Upload Documents</h3>
            <div class="upload-area" id="uploadArea">
                <p>üìÅ Drag & drop PDF files here or click to browse</p>
                <input type="file" id="fileInput" accept=".pdf" style="display: none;" multiple>
                <br><br>
                <button class="btn" onclick="document.getElementById('fileInput').click()">Choose Files</button>
            </div>
            <div id="uploadStatus"></div>
        </div>
        
        <div class="card">
            <h3>‚ùì Ask Questions</h3>
            <div class="search-box">
                <input type="text" id="queryInput" class="search-input" 
                       placeholder="Try: 'Compare termination procedures across all contracts' to see method differences..." 
                       onkeypress="handleKeyPress(event)">
                <button class="btn" onclick="searchDocuments()">Compare All Methods</button>
            </div>
            
            <div id="loading" class="loading">
                <div class="spinner"></div>
                Searching with all methods...
            </div>
            
            <div id="comparisonResults" style="display: none;">
                <h4>üîç Method Comparison</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                        <h5 style="color: #007bff; margin-bottom: 15px;">üîç Standard RAG</h5>
                        <div id="standardResult"></div>
                    </div>
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                        <h5 style="color: #28a745; margin-bottom: 15px;">üß† Intent Understanding</h5>
                        <div id="intentResult"></div>
                    </div>
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                        <h5 style="color: #dc3545; margin-bottom: 15px;">üöÄ LLM Synthesis</h5>
                        <div id="llmResult"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check system status
        async function checkStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                const statusEl = document.getElementById('status');
                
                if (data.status === 'healthy') {
                    statusEl.textContent = `‚úÖ System Healthy | ${data.collection.points_count} chunks | ${data.framework}`;
                    statusEl.className = 'status healthy';
                } else {
                    statusEl.textContent = '‚ùå System Unhealthy';
                    statusEl.className = 'status error';
                }
            } catch (error) {
                document.getElementById('status').textContent = '‚ùå Connection Failed';
            }
        }
        
        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        async function handleFiles(files) {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.innerHTML = '';
            
            for (let file of files) {
                if (file.type !== 'application/pdf') {
                    statusEl.innerHTML += `<div class="error">‚ùå ${file.name}: Only PDF files are supported</div>`;
                    continue;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    statusEl.innerHTML += `<div>üì§ Uploading ${file.name}...</div>`;
                    
                    const response = await fetch('/ingest', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        statusEl.innerHTML += `<div class="success">‚úÖ ${result.document_name}: ${result.chunks_processed} chunks processed</div>`;
                        checkStatus(); // Refresh status
                    } else {
                        statusEl.innerHTML += `<div class="error">‚ùå ${file.name}: ${result.detail}</div>`;
                    }
                } catch (error) {
                    statusEl.innerHTML += `<div class="error">‚ùå ${file.name}: Upload failed</div>`;
                }
            }
        }
        
        // Search functionality
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchDocuments();
            }
        }
        
        async function searchDocuments() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) return;
            
            const loadingEl = document.getElementById('loading');
            const comparisonEl = document.getElementById('comparisonResults');
            
            loadingEl.style.display = 'block';
            comparisonEl.style.display = 'none';
            
            try {
                // Run all three methods in parallel
                const [standardResponse, intentResponse, llmResponse] = await Promise.all([
                    fetch('/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: query, k: 5 })
                    }),
                    fetch('/query_with_intent', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: query, k: 5 })
                    }),
                    fetch('/query_with_llm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: query, k: 5 })
                    })
                ]);
                
                const [standardData, intentData, llmData] = await Promise.all([
                    standardResponse.json(),
                    intentResponse.json(),
                    llmResponse.json()
                ]);
                
                loadingEl.style.display = 'none';
                
                // Display comparison results
                displayComparisonResults('standardResult', standardData, 'Standard RAG');
                displayComparisonResults('intentResult', intentData, 'Intent Understanding');
                displayComparisonResults('llmResult', llmData, 'LLM Synthesis');
                
                comparisonEl.style.display = 'block';
                
            } catch (error) {
                loadingEl.style.display = 'none';
                comparisonEl.innerHTML = `<div class="error">‚ùå Search failed: Connection error</div>`;
                comparisonEl.style.display = 'block';
            }
        }
        
        
        function displayComparisonResults(containerId, data, methodName) {
            const container = document.getElementById(containerId);
            
            if (data.error) {
                container.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                return;
            }
            
            const answerId = 'comp-answer-' + containerId + '-' + Math.random().toString(36).substr(2, 9);
            const isLongAnswer = data.answer && data.answer.length > 400;
            
            // Method info
            let html = `<div style="font-size: 12px; margin-bottom: 15px; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                <strong>üìä Results:</strong> ${data.total_results} | 
                <strong>‚è±Ô∏è Method:</strong> ${data.approach_used || methodName}
            </div>`;
            
            // Full answer with expand/collapse
            html += `<div class="answer" style="margin-bottom: 15px;">
                <h5 style="margin-bottom: 10px;">üí° Answer</h5>
                <div class="answer-text ${isLongAnswer ? 'collapsed' : ''}" id="${answerId}">
                    ${data.answer || 'No answer found'}
                </div>
                ${isLongAnswer ? `<button class="expand-btn" onclick="toggleAnswer('${answerId}')">Show Full Answer</button>` : ''}
            </div>`;
            
            // Sources section
            if (data.sources && data.sources.length > 0) {
                html += `<div class="sources">
                    <h5 style="margin-bottom: 10px;">üìö Sources (${data.sources.length})</h5>`;
                
                data.sources.slice(0, 3).forEach((source, index) => {
                    html += `<div class="source" style="margin-bottom: 8px; padding: 8px; background: #fff; border: 1px solid #eee; border-radius: 4px; font-size: 11px;">
                        <div style="font-weight: bold; margin-bottom: 3px;">
                            üìÑ ${source.document} | Page ${source.page} | Chunk ${source.chunk}
                            <span class="confidence">${Math.round(source.confidence * 100)}%</span>
                        </div>
                        <div style="font-style: italic; color: #666;">
                            "${source.text_excerpt}"
                        </div>
                    </div>`;
                });
                
                html += `</div>`;
            } else {
                html += `<div style="color: #666; font-style: italic;">No sources found</div>`;
            }
            
            container.innerHTML = html;
        }
        
        function toggleAnswer(answerId) {
            const answerEl = document.getElementById(answerId);
            const button = answerEl.parentElement.querySelector('.expand-btn');
            
            if (answerEl.classList.contains('collapsed')) {
                answerEl.classList.remove('collapsed');
                button.textContent = button.textContent.includes('Full') ? 'Show Less' : 'Show Less';
            } else {
                answerEl.classList.add('collapsed');
                button.textContent = button.textContent.includes('Less') ? 'Show Full' : 'Show Full Answer';
            }
        }
        
        // Initialize
        checkStatus();
        
        // Sample queries for testing - optimized to show differences between methods
        const sampleQueries = [
            "Compare termination procedures across all contracts",
            "How do payment terms differ between service and consulting agreements?",
            "What confidentiality obligations exist in all documents?", 
            "Compare intellectual property ownership across contracts",
            "What are the notice requirements for termination?",
            "How is compensation structured in different agreement types?"
        ];
        
        // Add sample query buttons
        document.addEventListener('DOMContentLoaded', () => {
            const searchBox = document.querySelector('.search-box');
            const samplesDiv = document.createElement('div');
            samplesDiv.innerHTML = '<p style="margin: 10px 0; font-size: 12px; color: #666;">üí° Try these sample queries:</p>';
            
            sampleQueries.forEach(query => {
                const btn = document.createElement('button');
                btn.textContent = query;
                btn.className = 'btn';
                btn.style.margin = '5px';
                btn.style.fontSize = '12px';
                btn.style.padding = '5px 10px';
                btn.onclick = () => {
                    document.getElementById('queryInput').value = query;
                    searchDocuments();
                };
                samplesDiv.appendChild(btn);
            });
            
            searchBox.parentNode.insertBefore(samplesDiv, searchBox.nextSibling);
        });
    </script>
</body>
</html>